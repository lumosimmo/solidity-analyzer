name: Rust Job

on:
  workflow_call:
    inputs:
      command:
        description: Command to run for the job.
        required: true
        type: string
      rustflags:
        description: RUSTFLAGS to apply (empty string to disable).
        required: false
        default: "-C link-arg=-fuse-ld=bfd -C debuginfo=0"
        type: string
      components:
        description: Comma-separated Rust components to install.
        required: false
        default: ""
        type: string
      use_sccache:
        description: Enable sccache.
        required: false
        default: true
        type: boolean
      use_rust_cache:
        description: Enable rust-cache.
        required: false
        default: true
        type: boolean
      free_disk:
        description: Free up disk space before building.
        required: false
        default: true
        type: boolean
      checkout:
        description: Checkout repository.
        required: false
        default: true
        type: boolean

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUST_BACKTRACE: short
  RUSTUP_MAX_RETRIES: 10
  CARGO_PROFILE_RELEASE_DEBUG: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  CARGO_PROFILE_TEST_DEBUG: 0

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: ${{ inputs.rustflags }}
    steps:
      - name: Checkout
        if: ${{ inputs.checkout }}
        uses: actions/checkout@v4

      - name: Free Disk Space
        if: ${{ inputs.free_disk }}
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker image prune --all --force
          df -h

      - name: Install Rust (with components)
        if: ${{ inputs.components != '' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          components: ${{ inputs.components }}

      - name: Install Rust
        if: ${{ inputs.components == '' }}
        uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        if: ${{ inputs.use_sccache }}
        uses: mozilla-actions/sccache-action@v0.0.3

      - name: Configure sccache
        if: ${{ inputs.use_sccache }}
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - name: Rust cache
        if: ${{ inputs.use_rust_cache }}
        uses: Swatinem/rust-cache@v2
        with:
          cache-directories: |
            ~/.cache/sccache

      - name: Run command
        run: ${{ inputs.command }}

      - name: sccache stats
        if: ${{ always() && inputs.use_sccache }}
        run: sccache --show-stats
